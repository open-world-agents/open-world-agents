name: Diff OWA/CWA

on:
  push:
    branches: [main]
  pull_request:
    types: [opened, synchronize]

jobs:
  compare:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      pull_has_changes: ${{ steps.compare.outputs.pull_has_changes }}
      push_has_changes: ${{ steps.compare.outputs.push_has_changes }}
      changes_summary: ${{ steps.compare.outputs.changes_summary }}
    steps:
      - uses: actions/checkout@v4
      - run: git clone https://github.com/open-world-agents/open-world-agents.git /tmp/upstream-owa
      - id: compare
        run: |
          chmod +x scripts/compare-owa.sh
          scripts/compare-owa.sh

      - if: steps.compare.outputs.push_has_changes == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: rsync-patch
          path: /tmp/rsync-changes.patch

  comment:
    runs-on: ubuntu-latest
    needs: compare
    if: github.event_name == 'pull_request' && (needs.compare.outputs.pull_has_changes == 'true' || needs.compare.outputs.push_has_changes == 'true')
    permissions:
      pull-requests: write
    steps:
      - uses: actions/github-script@v7
        env:
          CHANGES_SUMMARY: ${{ needs.compare.outputs.changes_summary }}
        with:
          script: |
            const pull = '${{ needs.compare.outputs.pull_has_changes }}' === 'true';
            const push = '${{ needs.compare.outputs.push_has_changes }}' === 'true';

            if (!pull && !push) return;

            let body = "";

            if (pull && push) {
              body += "‚ö†Ô∏è **Both directions have changes** - review carefully before syncing\n\n";
            }

            // Add detailed changes summary first
            const changesSummary = process.env.CHANGES_SUMMARY || '';
            if (changesSummary && changesSummary !== '') {
              body += changesSummary + "\n\n";
            }

            // Get the detailed report from workflow summary
            const summaryUrl = `${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}`;

            body += "<details><summary>üìã How to sync</summary>\n\n";

            if (pull) {
              body += "**üì• To pull upstream changes:**\n" +
                      "```bash\n" +
                      "git clone https://github.com/open-world-agents/open-world-agents.git /tmp/upstream\n" +
                      "rsync -av --delete --exclude='.git' /tmp/upstream/ ./open-world-agents/\n" +
                      "git add open-world-agents/\n" +
                      "git commit -m \"Sync with upstream open-world-agents\"\n" +
                      "```\n\n";
            }

            if (push) {
              body += "**üì§ To push local changes:**\n" +
                      "1. Download the `rsync-patch` artifact from this workflow\n" +
                      "2. Apply to your fork of open-world-agents\n" +
                      "3. Create a pull request\n\n" +
                      "Or use rsync:\n" +
                      "```bash\n" +
                      "git clone https://github.com/open-world-agents/open-world-agents.git /tmp/upstream-pr\n" +
                      "cd /tmp/upstream-pr\n" +
                      "git checkout -b sync-$(date +%Y%m%d)\n" +
                      "rsync -av --delete --exclude='.git' ../open-world-agents/ ./\n" +
                      "git add -A\n" +
                      "git commit -m \"Sync changes from proprietary\"\n" +
                      "git push origin sync-$(date +%Y%m%d)\n" +
                      "```\n\n";
            }

            body += "</details>\n\n";

            body += `*Full report also available in [workflow summary](${summaryUrl})*`;

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner, repo: context.repo.repo, issue_number: context.issue.number
            });
            const existing = comments.find(c => c.user.login === 'github-actions[bot]' && c.body.includes('üîÑ OWA Sync Status'));

            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner, repo: context.repo.repo, comment_id: existing.id, body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner, repo: context.repo.repo, issue_number: context.issue.number, body
              });
            }
