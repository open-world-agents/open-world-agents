name: Compare Open World Agents

on:
  push:
    branches: [main]
  pull_request:
    types: [opened, synchronize]

jobs:
  compare:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      pull_has_changes: ${{ steps.compare.outputs.pull_has_changes }}
      push_has_changes: ${{ steps.compare.outputs.push_has_changes }}
    steps:
      - uses: actions/checkout@v4
      - run: git clone https://github.com/open-world-agents/open-world-agents.git /tmp/upstream-owa
      - id: compare
        run: |
          chmod +x scripts/compare-owa.sh
          scripts/compare-owa.sh

      - if: steps.compare.outputs.push_has_changes == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: rsync-patch
          path: /tmp/rsync-changes.patch

  comment:
    runs-on: ubuntu-latest
    needs: compare
    if: github.event_name == 'pull_request' && (needs.compare.outputs.pull_has_changes == 'true' || needs.compare.outputs.push_has_changes == 'true')
    permissions:
      pull-requests: write
    steps:
      - uses: actions/github-script@v7
        with:
          script: |
            const pull = '${{ needs.compare.outputs.pull_has_changes }}' === 'true';
            const push = '${{ needs.compare.outputs.push_has_changes }}' === 'true';

            let body = "## ðŸ”„ Open World Agents Sync Options\n\nChoose your preferred sync method:\n\n";

            if (pull) {
              body += "### ðŸ“¥ Pull Changes (Upstream â†’ Proprietary)\n\n" +
                      "**Option A: Git Subtree (preserves history)**\n" +
                      "```bash\n" +
                      "cd open-world-agents\n" +
                      "git subtree pull --prefix=. owa main --squash\n" +
                      "cd ..\n" +
                      "git add open-world-agents/\n" +
                      "git commit -m \"Update open-world-agents via subtree\"\n" +
                      "```\n\n" +
                      "**Option B: File Sync (clean, no history)**\n" +
                      "```bash\n" +
                      "git clone https://github.com/open-world-agents/open-world-agents.git /tmp/upstream\n" +
                      "rsync -av --delete /tmp/upstream/ ./open-world-agents/\n" +
                      "git add open-world-agents/\n" +
                      "git commit -m \"Sync with upstream open-world-agents\"\n" +
                      "```\n\n";
            }

            if (push) {
              body += "### ðŸ“¤ Push Changes (Proprietary â†’ Upstream)\n\n" +
                      "**Option A: Git Subtree (preserves history)**\n" +
                      "```bash\n" +
                      "cd open-world-agents\n" +
                      "git subtree push --prefix=. owa feature-branch\n" +
                      "# Then create PR from feature-branch\n" +
                      "```\n\n" +
                      "**Option B: File Sync (clean, squashed)**\n" +
                      "1. Download the [`rsync-patch` artifact](https://github.com/" + context.repo.owner + "/" + context.repo.repo + "/actions/runs/" + context.runId + ") from this workflow\n" +
                      "2. Or use this script:\n" +
                      "```bash\n" +
                      "git clone https://github.com/open-world-agents/open-world-agents.git /tmp/upstream-pr\n" +
                      "cd /tmp/upstream-pr\n" +
                      "git checkout -b sync-$(date +%Y%m%d)\n" +
                      "rsync -av --delete ./open-world-agents/ ./\n" +
                      "git add -A\n" +
                      "git commit -m \"Sync changes from proprietary (squashed)\"\n" +
                      "git push origin sync-$(date +%Y%m%d)\n" +
                      "# Create PR on GitHub\n" +
                      "```\n\n";
            }

            if (!pull && !push) {
              body += "âœ… **Everything is in sync!**\n\n" +
                      "Both git subtree and file-based comparisons show no differences.\n";
            }

            body += "\n### ðŸ¤” Which Method to Choose?\n\n" +
                    "- **Git Subtree**: Preserves commit history, better for ongoing collaboration\n" +
                    "- **File Sync (rsync)**: Clean squashed changes, better for occasional syncs\n\n" +
                    "---\n" +
                    "*Updated automatically on PR changes*";

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner, repo: context.repo.repo, issue_number: context.issue.number
            });
            const existing = comments.find(c => c.user.type === 'Bot' && c.body.includes('Open World Agents Sync Options'));

            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner, repo: context.repo.repo, comment_id: existing.id, body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner, repo: context.repo.repo, issue_number: context.issue.number, body
              });
            }
